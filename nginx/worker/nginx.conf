worker_processes auto;
rtmp_auto_push on;
events {
    worker_connections 1024;
}
rtmp {
    server {
        listen 1935;
        listen [::]:1935 ipv6only=on;
        chunk_size 4096;
        buflen 10s;
        drop_idle_publisher 10s;

        # To enable HLS
        hls on;
        hls_fragment 4s;
        hls_playlist_length 60s;
        hls_fragment_slicing aligned;
        hls_cleanup on;
        hls_continuous on;
        # hls_type live;

        record_path /tmp/rec;

        application src {
            live on;
            interleave on;

            record all;

            hls_path /tmp/raw;

            exec_publish bash /var/scripts/src/push_hls.sh $name;
            exec_record_done bash /var/scripts/src/on_record_done.sh $path $dirname/$basename;
        }

        application task {
            live on;
            interleave on;

            record off;

            hls_path /tmp/hls;
            hls_nested on;

            hls_variant _low AVERAGE-BANDWIDTH=1200000,BANDWIDTH=1280000,RESOLUTION=852x480,CLOSED-CAPTIONS=NONE;
            # hls_variant _mid AVERAGE-BANDWIDTH=2710000,BANDWIDTH=2560000,RESOLUTION=1280x720,FRAME-RATE=24.000,CODECS="avc1.4d001f,mp4a.40.2",CLOSED-CAPTIONS=NONE;
            # hls_variant _hi AVERAGE-BANDWIDTH=4170000,BANDWIDTH=5210000,RESOLUTION=1920x1080,FRAME-RATE=24.000,CODECS="avc1.4d4028,mp4a.40.2",CLOSED-CAPTIONS=NONE;

            exec_publish bash /var/scripts/task/on_publish.sh $name;
        }
    }
}